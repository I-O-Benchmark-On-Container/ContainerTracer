import os

Import("env")

CURRENT_PROJECT = "runner"

current_env = env.Clone()
current_env.Append(CPPPATH=[env["INCLUDE_LOCATION"]])
current_env.Append(LIBS=["json-c", "jemalloc"])
current_env.Append(CFLAGS=["-I/usr/include/json-c/"])
current_env.Append(
    CCFLAGS=[
        "-std=c11",
        "-Wall",
        "-Werror",
        "-Wextra",
        "-Wcast-align",
        "-Wwrite-strings",
        "-Wpointer-arith",
        "-Wswitch-default",
        "-Wunreachable-code",
        "-Winit-self",
        "-Wmissing-field-initializers",
        "-Wno-unknown-pragmas",
        "-Wstrict-prototypes",
        "-Wundef",
        "-Wold-style-definition",
#"-Wpedantic",
    ]
)

current_env.Program(
    target=env["PROGRAM_LOCATION"] + "/" + CURRENT_PROJECT, source=Glob("*.c")
)

exclude_files = [str(Dir(env["RUNNER_LOCATION"])) + os.sep + "main.c"]
except_main = [
    x for x in Glob(env["RUNNER_LOCATION"] + "/*.c") if not str(x) in exclude_files
]

current_env.SharedLibrary(
    target=env["PROGRAM_LOCATION"] + "/" + CURRENT_PROJECT + ".so", source=except_main
)

if current_env["BUILD_UNIT_TEST"] == True:
    SConscript("test/SConscript")
